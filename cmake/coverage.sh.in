#!/usr/bin/env bash

set -e

SOURCE_DIR=@CMAKE_SOURCE_DIR@
BUILD_DIR=@CMAKE_BINARY_DIR@

mkdir $BUILD_DIR/coverage
cd $BUILD_DIR/coverage

lcov -b $SOURCE_DIR -c -i -d $BUILD_DIR -o .coverage.wtest.base
ctest
lcov -b $SOURCE_DIR -c -d $BUILD_DIR -o .coverage.wtest.run
lcov -a .coverage.wtest.base -a .coverage.wtest.run  -o .coverage.total
lcov -e .coverage.total $SOURCE_DIR/src/\* -o .coverage.total.filtered
lcov -r .coverage.total.filtered $BUILD_DIR/\* -o .coverage.total.filtered
lcov -r .coverage.total.filtered $SOURCE_DIR/src/test/\* -o .coverage.total.filtered
genhtml --dark-mode -o ./html/ .coverage.total
